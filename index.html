<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>æƒ‡é™½å¯¦ç¸¾åœ°åœ– - 3D å°ˆæ¥­æ•´åˆä¿®æ­£ç‰ˆ</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <style>
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; display: flex; font-family: 'Microsoft JhengHei', sans-serif; overflow: hidden; background: #f0f2f5; }
        #map { flex-grow: 1; height: 100%; position: relative; }
        #sidebar { width: 420px; height: 100%; background: #ffffff; border-left: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 10; }
        .accordion-item { border-bottom: 1px solid #eee; background: #fff; }
        .accordion-header { padding: 15px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
        .accordion-header.active .arrow-icon { transform: rotate(180deg); }
        .section-title { font-size: 14px; font-weight: bold; color: #1A5276; display: flex; align-items: center; margin: 0; }
        .section-title::before { content: ""; width: 4px; height: 14px; background: #1A5276; margin-right: 8px; border-radius: 2px; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #fff; }
        .accordion-content.show { max-height: 1000px; padding-bottom: 15px; }
        .filter-padding { padding: 0 15px; }
        .instruction-box { background: #eef2f5; padding: 10px; border-radius: 6px; font-size: 11px; margin-bottom: 10px; color: #555; border-left: 4px solid #FF5722; }
        .filter-group { margin-bottom: 10px; }
        select, input[type="text"] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dfe6e9; box-sizing: border-box; font-size: 13px; }
        .checkbox-group { max-height: 160px; overflow-y: auto; border: 1px solid #dfe6e9; border-radius: 6px; padding: 8px; background: #fff; }
        .checkbox-item { display: flex; align-items: center; font-size: 12px; margin-bottom: 5px; cursor: pointer; }
        .checkbox-item input { margin-right: 8px; width: 16px; height: 16px; }
        #result-list { flex-grow: 1; overflow-y: auto; padding: 10px 15px; background: #f8f9fa; }
        .result-item { background: white; margin-bottom: 8px; border-radius: 8px; border-left: 6px solid #1A5276; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 10px; }
        .item-title { font-size: 13px; font-weight: bold; color: #333; }
        .item-subtitle { font-size: 11px; color: #666; margin-top: 4px; }
        .map-style-ctrl { position: absolute; top: 10px; left: 10px; z-index: 100; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .range-slider-container { position: relative; height: 35px; margin-top: 5px; }
        .range-slider-container input { position: absolute; width: 100%; pointer-events: none; -webkit-appearance: none; background: none; z-index: 2; }
        .range-slider-container input::-webkit-slider-thumb { position: relative; z-index: 5; pointer-events: auto; width: 18px; height: 18px; border-radius: 50%; background: #1A5276; -webkit-appearance: none; cursor: pointer; border: 2px solid #fff; }
        .btn-export { background: #27AE60; color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 14px; }
/* --- CSS é–‹å§‹ --- */

/* 1. å¼·åˆ¶åœ°åœ–å½ˆçª—ï¼ˆPopupï¼‰å±¤ç´šç½®é ‚ï¼Œç¢ºä¿ä¸è¢«åœ“é»è¦†è“‹ */
.maplibregl-popup {
    z-index: 999999 !important; 
}

.maplibregl-popup-content {
    padding: 0 !important; /* ç§»é™¤å…§è·è®“åœ–ç‰‡èˆ‡å‡çµæ¨™é¡Œå¡«æ»¿ */
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    border-radius: 8px;
    overflow: hidden;
}

/* 2. å°çª—å…§éƒ¨å®¹å™¨èˆ‡æ»¾å‹•è¨­å®š */
.popup-container { 
    width: 320px; 
    font-size: 12px; 
    line-height: 1.5; 
    max-height: 450px; 
    overflow-y: auto; 
    background: #ffffff;
    position: relative;
}

/* 3. æ ¸å¿ƒåŠŸèƒ½ï¼šæ¡ˆåã€ç²çè³‡è¨Šèˆ‡åœ–ç‰‡ é¦–æ¬„å‡çµ */
.sticky-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #ffffff;
    border-bottom: 2px solid #27AE60;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.sticky-æ¡ˆå {
    padding: 12px 15px 5px 15px;
    font-size: 14px;
    font-weight: bold;
    color: #27AE60;
}

.sticky-ç²ç {
    padding: 0 15px 10px 15px;
    font-size: 11px;
    color: #E67E22;
    font-weight: bold;
}

/* 4. åœ–ç‰‡è‡ªå‹•ç¸®æ”¾è‡³æ¡†å…§ */
.popup-container img { 
    width: 100% !important; 
    height: auto !important; 
    display: block;
}

/* 5. è¡¨æ ¼æ’ç‰ˆèˆ‡ç¬¬ä¸€åˆ—å¯¬åº¦ä¿®æ­£ */
.popup-container .content-box { padding: 0 15px 15px 15px; } 
.popup-container table { width: 100%; border-collapse: collapse; margin-top: 5px; }
.popup-container td { vertical-align: top; padding: 6px 4px; border-bottom: 1px solid #f0f0f0; }
.popup-container td:first-child { 
    width: 95px; 
    color: #1A5276; /* æ”¹å›è—è‰²æ¨™é¡Œæ›´ç¾è§€ */
    font-weight: bold; 
    background: #f9fbfc;
    border-right: 1px solid #eee;
    padding: 6px 8px; /* å¢åŠ å…§è· */
}
/* --- CSS çµæŸ --- */

/* è‡ªå®šç¾©å‚ç›´æŠ•å½±æŒ‰éˆ•æ¨£å¼ */
.maplibregl-ctrl-pitch {
    background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z' fill='%23333'/%3E%3C/svg%3E");
    background-size: 20px;
    background-repeat: no-repeat;
    background-position: center;
}

    </style>
</head>
<body>

<div id="status" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9999; background:rgba(0,0,0,0.8); color:white; padding:10px 25px; border-radius:30px;">æ­£åœ¨è®€å–è³‡æ–™...</div>

<div id="map">
<div class="map-style-ctrl">
    <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">ğŸ—ºï¸ åœ°åœ–èˆ‡å½±åƒ</div>
    <select id="style-selector" onchange="switchStyle(this.value)" style="padding:5px; width: 100%;">
        <option value="osm">æ¨™æº–åœ°åœ–</option>
        <option value="esri">è¡›æ˜Ÿå½±åƒ</option>
    </select>
</div>
</div>

<div id="sidebar">
    <div class="accordion-item">
        <div class="accordion-header active" onclick="toggleAccordion(this, 'content1')">
            <h3 class="section-title">ç¬¬ä¸€éšæ®µï¼šç©ºé–“ç¯©é¸</h3><span class="arrow-icon">â–¼</span>
        </div>
        <div id="content1" class="accordion-content show">
            <div class="filter-padding">
                <div class="instruction-box">ğŸ’¡ å–®æ“Šæ–°å¢é»ï¼Œé›™æ“ŠçµæŸé–‰åˆå€åŸŸã€‚</div>
                <button style="background:#1A5276; color:white; border:none; padding:10px; width:100%; border-radius:6px; cursor:pointer; font-weight:bold;" onclick="startDraw()">ğŸ“ ç¹ªè£½ç¯©é¸å€åŸŸ</button>
                <button style="background:#b2bec3; color:white; border:none; padding:5px; width:100%; border-radius:6px; cursor:pointer; margin-top:5px; font-size:11px;" onclick="clearSpatialFilter()">âœ• æ¸…é™¤å€åŸŸ</button>
                <select id="city-filter" onchange="handleCityFilter()" style="margin-top:10px;">
                    <option value="å…¨åœ‹">--- ç¸£å¸‚è·³è½‰ ---</option>
                </select>
            </div>
        </div>
    </div>

    <div class="accordion-item">
        <div class="accordion-header" id="header2" onclick="toggleAccordion(this, 'content2')">
            <h3 class="section-title">ç¬¬äºŒéšæ®µï¼šå±¬æ€§ç¯©é¸</h3><span class="arrow-icon">â–¼</span>
        </div>
<div id="content2" class="accordion-content show">
    <div class="filter-padding">
        <div class="checkbox-group" id="type-checkbox-group"></div>
        <input type="text" id="search-input" placeholder="ğŸ” æœå°‹ (æ¡ˆè™Ÿã€ç°¡ç¨±ã€ä¸»æŒäºº)" oninput="filterProjects()" style="margin-top:10px;">
        
        <div id="price-display" style="font-size:11px; color:#1A5276; margin-top:10px; text-align:center;">ç¶“è²»ï¼š0 ~ 5å„„+</div>
        <div class="range-slider-container">
            <input type="range" id="min-slider" min="0" max="6" value="0" oninput="handleSlider()">
            <input type="range" id="max-slider" min="0" max="6" value="6" oninput="handleSlider()">
        </div>

        <div class="filter-group" style="margin-top:15px;">
            <div id="start-year-display" style="font-size:11px; color:#E67E22; text-align:center; font-weight:bold;">é–‹å§‹å¹´ä»½ï¼š2010 ä»¥ä¸Š</div>
            <div class="range-slider-container">
                <input type="range" id="filter-start-year" min="2010" max="2026" value="2010" oninput="handleDateFilter()">
            </div>
            
            <div id="end-year-display" style="font-size:11px; color:#E67E22; margin-top:10px; text-align:center; font-weight:bold;">çµæŸå¹´ä»½ï¼š2026 ä»¥ä¸‹</div>
            <div class="range-slider-container">
                <input type="range" id="filter-end-year" min="2010" max="2026" value="2026" oninput="handleDateFilter()">
            </div>
        </div>

        <button class="btn-export" onclick="exportToCSV()">ğŸ“Š åŒ¯å‡ºæ‰€é¸ CSV</button>
        <button class="btn-export" style="background: #E67E22; margin-top: 5px;" onclick="exportSatelliteImageBatch()">ğŸ–¼ï¸ æ‰¹é‡åŒ¯å‡ºé«˜æ¸…è¡›æ˜Ÿåœ–</button>
    </div>
</div>
    </div>
    <div id="result-count" style="font-size:12px; color:#1A5276; padding:10px; background:#eef2f5; font-weight:bold;">ç¬¦åˆï¼š0 ç­†</div>
    <div id="result-list"></div>
</div>

<script>
    // 12 ç¨®é¡åˆ¥é¡è‰²å®šç¾©
    const categoryColors = {
        "ç”¢æ¥­åœ’å€é–‹ç™¼": "#E74C3C", "éƒ½å¸‚è¨ˆç•«åŠéƒ½å¸‚æ›´æ–°": "#8E44AD", "åœ‹åœŸè¨ˆç•«åŠééƒ½å¸‚åœŸåœ°é–‹ç™¼": "#2E86C1",
        "å¤ªé™½èƒ½åŸºåœ°è¨­è¨ˆ": "#F1C40F", "ä¿ƒåƒæ‹›å•†": "#16A085", "éŠæ†©è¦åŠƒ": "#FF1493",
        "å»ºç¯‰è¨­è¨ˆ": "#00CED1", "æ™¯è§€è¨­è¨ˆ": "#27AE60", "éŠæˆ²å ´è¨­è¨ˆ": "#E67E22",
        "VSCAPE è¶Šå—æ™¯è§€è¨­è¨ˆ": "#D35400", "éƒ½å¸‚è¨­è¨ˆ": "#7F8C8D", "å°ˆæ¡ˆç®¡ç†": "#2C3E50"
    };

    const terrainRGB = { "type": "raster-dem", "tiles": ["https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png"], "encoding": "terrarium", "tileSize": 256 };
    const buildings = { "type": "vector", "tiles": ["https://{s}.data.osmbuildings.org/0.2/59f80695/tile/{z}/{x}/{y}.json"] };

    const osmStyle = {
        "version": 8,
        "sources": {
            "osm": { "type": "raster", "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize": 256 },
            "osm-buildings": buildings,
            "t-rgb": terrainRGB
        },
        "layers": [
            { "id": "osm-layer", "type": "raster", "source": "osm" },
            { "id": "3d-buildings", "type": "fill-extrusion", "source": "osm-buildings", "source-layer": "building", "paint": { "fill-extrusion-color": "#fff", "fill-extrusion-height": ["get", "height"], "fill-extrusion-opacity": 0.6 } }
        ],
        "terrain": { "source": "t-rgb", "exaggeration": 1.2 }
    };

const esriStyle = {
    "version": 8,
    "sources": {
        "esri": { 
            "type": "raster", 
            "tiles": ["https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"], 
            "tileSize": 256, // ä¿æŒ 256 æˆ–è©¦è‘—æ”¹ç‚º 512 è§€å¯Ÿè‰²å·®
            "attribution": "Esri" 
        },
        "t-rgb": terrainRGB
    },
    "layers": [{ "id": "esri-layer", "type": "raster", "source": "esri" }],
    "terrain": { "source": "t-rgb", "exaggeration": 1 }
};
    var map = new maplibregl.Map({ container: 'map', style: osmStyle, center: [121.0, 23.8], zoom: 7, pitch: 45 });
    map.addControl(new maplibregl.NavigationControl());
map.on('click', (e) => {});
// åœ¨åŸç”Ÿçš„ NavigationControl å®¹å™¨ä¸­æ’å…¥æŒ‰éˆ•
const navGroup = document.querySelector('.maplibregl-ctrl-group');
if (navGroup) {
    // 1. å‚ç›´æŠ•å½±æŒ‰éˆ•
    const pitchBtn = document.createElement('button');
    pitchBtn.className = 'maplibregl-ctrl-icon maplibregl-ctrl-pitch';
    pitchBtn.type = 'button';
    pitchBtn.title = 'æ¢å¾©å‚ç›´æŠ•å½± (2D)';
    pitchBtn.onclick = () => map.easeTo({ pitch: 0 });
    navGroup.appendChild(pitchBtn);

    // 2. é–‹é—œç«‹é«”åœ°å½¢æŒ‰éˆ•
    let terrainEnabled = true; // é è¨­é–‹å•Ÿ
    const terrainBtn = document.createElement('button');
    terrainBtn.className = 'maplibregl-ctrl-icon maplibregl-ctrl-terrain';
    terrainBtn.type = 'button';
    terrainBtn.title = 'é–‹å•Ÿ/é—œé–‰ç«‹é«”åœ°å½¢';
    terrainBtn.innerHTML = 'â›°ï¸'; // ä½¿ç”¨ Emoji æˆ–è‡ªå®šç¾©åœ–ç¤º
    terrainBtn.style.fontSize = '16px';
    
    terrainBtn.onclick = () => {
        terrainEnabled = !terrainEnabled;
        if (terrainEnabled) {
            // é‡æ–°å•Ÿç”¨åœ°å½¢ (ä½¿ç”¨å®šç¾©å¥½çš„æ•¸æ“šæº)
            map.setTerrain({ 'source': 't-rgb', 'exaggeration': 1.5 });
            terrainBtn.style.background = '#eee'; // æŒ‰ä¸‹ç‹€æ…‹
        } else {
            // é—œé–‰åœ°å½¢
            map.setTerrain(null);
            terrainBtn.style.background = '#fff';
        }
    };
    navGroup.appendChild(terrainBtn);
}
    var projectData = [];
    var polygonFilter = null;
    const levelNames = ["0", "100è¬", "1000è¬", "5000è¬", "1å„„", "5å„„", "5å„„+"];
    const levels = [0, 1e6, 1e7, 5e7, 1e8, 5e8, 1e12];

    function loadSpreadsheetData() {
    const ssId = "19GZRlk-nx6xR-EL3JtS6bBrB_POCPIQgQdeKVN5O7C8";
    const sheets = Object.keys(categoryColors);
    let loaded = 0;
    sheets.forEach((name, idx) => {
        const cbName = `cb_${idx}`;
        window[cbName] = (json) => {
            if (json.table) {
                json.table.rows.forEach(row => {
                    const get = (i) => (row.c && row.c[i]) ? (row.c[i].f || row.c[i].v || "") : "";
                    let wkt = String(get(0));
                    if (!wkt || wkt.includes("åº§æ¨™") || wkt === "--") return;

                    // ä¾åºæŠ“å– 17 å€‹æ¬„ä½ (A-Q)
                    projectData.push({
                        wkt: wkt,                    // A: åº§æ¨™
                        æ¡ˆè™Ÿ: get(1),                // B
                        æ¡ˆä»¶ç°¡ç¨±: get(2),            // C
                        å¥‘ç´„æ¡ˆå: get(3),            // D
                        å·¥ç¨‹åç¨±: get(4),            // E
                        æ¥­ä¸»: get(5),                // F
                        æ‰€åœ¨ä½ç½®: get(6),            // G
                        é¢ç©è¦æ¨¡: get(7),            // H
                        ç¶“è²»: get(8),                // I
                        ç¶“è²»å€¼: parseFloat(String(get(8)).replace(/[^0-9.]/g, "")) || 0,
                        å¯¦ç¸¾ç…§ç‰‡: get(9),            // J
                        æ¡ˆä»¶å±¬æ€§: get(10),           // K
                        ç²çè³‡è¨Š: get(11),           // L
                        åŸ·è¡Œçµ„åˆ¥: get(12),           // M
                        è¨ˆç•«ä¸»æŒäºº: get(13),         // N
                        é—œéµæ³•æ¢: get(14),           // O
                        èµ·è¨–æ—¥æœŸ: get(15),           // P
                        å‚™è¨»: get(16),               // Q
                        åˆ†é¡: name,
                        ç¸£å¸‚: String(get(6)).substring(0, 3),
                        selected: true
                    });
                });
            }
            if (++loaded === sheets.length) finalize();
        };
        const s = document.createElement('script');
        s.src = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=responseHandler:${cbName}&sheet=${encodeURIComponent(name)}`;
        document.body.appendChild(s);
    });
}

    function finalize() {
        document.getElementById('status').style.display = 'none';
        const cities = [...new Set(projectData.map(p => p.ç¸£å¸‚))].filter(c => c.length >= 2).sort();
        cities.forEach(c => document.getElementById('city-filter').innerHTML += `<option value="${c}">${c}</option>`);
        projectData.forEach(p => { p.marker = createProjectMarker(p); });
        filterProjects();
    }

function createProjectMarker(p) {
    let coords = parseWKT(p.wkt);
    if (!coords) return null;
    const el = document.createElement('div');
    const color = categoryColors[p.åˆ†é¡] || "#333";
    
    // è¨­å®šé»ä½æ¨£å¼ï¼ŒzIndex è¨­ç‚º 0
    el.style.width = '14px';
    el.style.height = '14px';
    el.style.backgroundColor = color;
    el.style.borderRadius = '50%';
    el.style.border = '2px solid #ffffff';
    el.style.cursor = 'pointer';
    el.style.zIndex = '0'; // é»ä½å±¤ç´šæœ€ä½
    el.style.boxShadow = '0 0 6px rgba(0,0,0,0.6)';

    let imageUrl = p.å¯¦ç¸¾ç…§ç‰‡;
    if (imageUrl && imageUrl.includes('drive.google.com')) {
        const fileIdMatch = imageUrl.match(/[-\w]{25,}/);
        if (fileIdMatch) imageUrl = `https://drive.google.com/thumbnail?authuser=0&sz=w1000&id=${fileIdMatch[0]}`;
    }
let startDate = "--";
let endDate = "--";
if (p.èµ·è¨–æ—¥æœŸ && p.èµ·è¨–æ—¥æœŸ.includes('-')) {
    const parts = p.èµ·è¨–æ—¥æœŸ.split('-');
    startDate = parts[0].trim();
    endDate = parts[1].trim();
} else if (p.èµ·è¨–æ—¥æœŸ) {
    startDate = p.èµ·è¨–æ—¥æœŸ;
}
// é‡æ–°ç·¨æ’ HTMLï¼šæ¡ˆåèˆ‡åœ–ç‰‡ç½®é ‚å‡çµ
const popupHtml = `
    <div class="popup-container">
        <div class="sticky-header">
            <div class="sticky-æ¡ˆå">${p.å¥‘ç´„æ¡ˆå || p.æ¡ˆä»¶ç°¡ç¨±}</div>
            ${p.ç²çè³‡è¨Š ? `<div class="sticky-ç²ç">ğŸ† ${p.ç²çè³‡è¨Š}</div>` : ''}
            ${imageUrl ? `<img src="${imageUrl}" onerror="this.style.display='none'">` : ''}
        </div>
        <div class="content-box">
<table>
                <tr><td>æ¡ˆè™Ÿ</td><td>${p.æ¡ˆè™Ÿ}</td></tr>
                <tr><td>æ¡ˆä»¶ç°¡ç¨±</td><td>${p.æ¡ˆä»¶ç°¡ç¨±}</td></tr>
                <tr><td>å·¥ç¨‹åç¨±</td><td>${p.å·¥ç¨‹åç¨±}</td></tr>
                <tr><td>æ¥­ä¸»</td><td>${p.æ¥­ä¸»}</td></tr>
                <tr><td>é–‹å§‹æ—¥æœŸ</td><td>${startDate}</td></tr>
                <tr><td>çµæŸæ—¥æœŸ</td><td>${endDate}</td></tr>
                <tr><td>æ‰€åœ¨ä½ç½®</td><td>${p.æ‰€åœ¨ä½ç½®}</td></tr>
                <tr><td>é¢ç©è¦æ¨¡</td><td>${p.é¢ç©è¦æ¨¡}</td></tr>
                <tr><td>ç¶“è²»</td><td>${p.ç¶“è²»}</td></tr>
                <tr><td>åŸ·è¡Œçµ„åˆ¥</td><td>${p.åŸ·è¡Œçµ„åˆ¥}</td></tr>
                <tr><td>è¨ˆç•«ä¸»æŒäºº</td><td>${p.è¨ˆç•«ä¸»æŒäºº}</td></tr>
                <tr><td>é—œéµæ³•æ¢</td><td>${p.é—œéµæ³•æ¢}</td></tr>
                <tr><td>å‚™è¨»</td><td>${p.å‚™è¨»}</td></tr>
                <tr><td>å¯¦ç¸¾åˆ†é¡</td><td>${p.åˆ†é¡}</td></tr>
                </table>
            </div>
        </div>`;
// Marker ç¨ç«‹å»ºç«‹ï¼Œé»æ“Šæ‰è§¸ç™¼ Popup ---
    const marker = new maplibregl.Marker({ 
        element: el, 
        anchor: 'center' 
    }).setLngLat(coords);

    el.addEventListener('click', (e) => {
        e.stopPropagation(); 
        
        // å…ˆé—œé–‰å…¨åœ°åœ–æ‰€æœ‰ç¾æœ‰çš„ Popup (å¯¦ä½œæ’ä»–æ€§)
        const activePopups = document.getElementsByClassName('maplibregl-popup');
        while (activePopups[0]) { activePopups[0].remove(); }

        // åœ¨è©²åº§æ¨™è™•å»ºç«‹å–®ä¸€ Popup
        new maplibregl.Popup({
            offset: 40, 
            maxWidth: '340px',
            anchor: 'bottom',
            closeButton: true,
            closeOnClick: true 
        })
        .setLngLat(coords)
        .setHTML(popupHtml)
        .addTo(map);
       
    });

    return marker;
}
function handleDateFilter() {
    const startV = document.getElementById('filter-start-year').value;
    const endV = document.getElementById('filter-end-year').value;
    document.getElementById('start-year-display').innerText = `é–‹å§‹å¹´ä»½ï¼š${startV} ä»¥ä¸Š`;
    document.getElementById('end-year-display').innerText = `çµæŸå¹´ä»½ï¼š${endV} ä»¥ä¸‹`;
    filterProjects();
}
    function parseWKT(wkt) {
        try {
            let match = wkt.includes("POINT") ? wkt.match(/\(([^)]+)\)/)[1].trim().split(/\s+/) : wkt.match(/\(\(([^,]+)/)[1].trim().split(/\s+/);
            return [parseFloat(match[0]), parseFloat(match[1])];
        } catch(e) { return null; }
    }

    function toggleSelect(e, i) {
        e.stopPropagation();
        projectData[i].selected = e.target.checked;
        if (projectData[i].selected) projectData[i].marker.addTo(map);
        else projectData[i].marker.remove();
    }

// --- JavaScript é–‹å§‹ ---

function filterProjects() {
    const city = document.getElementById('city-filter').value;
    const searchStr = document.getElementById('search-input').value.toLowerCase();
    const minV = levels[document.getElementById('min-slider').value];
    const maxV = levels[document.getElementById('max-slider').value];
    const checkedTypes = Array.from(document.querySelectorAll('#type-checkbox-group input:checked')).map(el => el.value);
    const list = document.getElementById('result-list');
    const filterStartY = parseInt(document.getElementById('filter-start-year').value);
    const filterEndY = parseInt(document.getElementById('filter-end-year').value);
    
    list.innerHTML = '';
    let count = 0;

    projectData.forEach((p, index) => {
        if (!p.marker) return;
        let mSpatial = polygonFilter ? turf.booleanPointInPolygon(turf.point(p.marker.getLngLat().toArray()), polygonFilter) : (city === "å…¨åœ‹" || p.ç¸£å¸‚ === city);
        let mType = checkedTypes.includes(p.åˆ†é¡);
        let mPrice = (p.ç¶“è²»å€¼ >= minV && p.ç¶“è²»å€¼ <= maxV);
        let mSearch = !searchStr || (p.æ¡ˆä»¶ç°¡ç¨± + p.æ¥­ä¸» + p.è¨ˆç•«ä¸»æŒäºº + p.æ¡ˆè™Ÿ).toLowerCase().includes(searchStr);
let mYearMatch = true;
        if (p.èµ·è¨–æ—¥æœŸ && p.èµ·è¨–æ—¥æœŸ.includes('.')) {
            const years = p.èµ·è¨–æ—¥æœŸ.match(/\d{4}/g); 
            if (years && years.length >= 1) {
                const projectStart = parseInt(years[0]);
                const projectEnd = years.length > 1 ? parseInt(years[1]) : projectStart;

                // åš´æ ¼ç¯©é¸ï¼šé–‹å§‹æ™‚é–“å¿…é ˆåœ¨ç¯„åœå¾Œï¼ŒçµæŸæ™‚é–“å¿…é ˆåœ¨ç¯„åœå‰
                mYearMatch = (projectStart >= filterStartY && projectEnd <= filterEndY);
            }
        }
if (mSpatial && mType && mPrice && mSearch && mYearMatch) {
            count++;
            if (p.selected) p.marker.addTo(map); else p.marker.remove();
            let div = document.createElement('div');
            div.className = 'result-item'; div.style.borderLeft = `6px solid ${categoryColors[p.åˆ†é¡]}`;
            div.innerHTML = `
                <div style="display:flex;align-items:center;">
                    <input type="checkbox" ${p.selected?'checked':''} onclick="toggleSelect(event,${index})" style="margin-right:10px;">
                    <div style="flex:1" onclick="map.flyTo({center:[${p.marker.getLngLat().lng},${p.marker.getLngLat().lat}],zoom:16,pitch:65}); p.marker.togglePopup()">
                        <div class="item-title">${p.æ¡ˆä»¶ç°¡ç¨±}</div>
                        <div class="item-subtitle">${p.æ¥­ä¸»}</div>
                    </div>
                </div>`;
            list.appendChild(div);
        } else { p.marker.remove(); }
    });
    document.getElementById('result-count').innerText = `ç¬¦åˆï¼š ${count} ç­†`;
}
    // ç¹ªè£½åŠŸèƒ½
    let drawPoints = [];
    function startDraw() {
        drawPoints = []; clearSpatialFilter(); map.getCanvas().style.cursor = 'crosshair';
        if (!map.getSource('draw-path')) {
            map.addSource('draw-path', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
            map.addLayer({ id: 'draw-fill', type: 'fill', source: 'draw-path', paint: { 'fill-color': '#FF5722', 'fill-opacity': 0.3 } });
            map.addLayer({ id: 'draw-line', type: 'line', source: 'draw-path', paint: { 'line-color': '#FF5722', 'line-width': 5, 'line-dasharray': [1,1] } });
        }
        map.on('click', handleDrawClick); map.on('dblclick', handleDrawDblClick); map.doubleClickZoom.disable();
    }
    function handleDrawClick(e) { drawPoints.push([e.lngLat.lng, e.lngLat.lat]); updateDraw(); }
    function handleDrawDblClick(e) { e.originalEvent.preventDefault(); if (drawPoints.length >= 3) finishDraw(); }
    function updateDraw() { if (drawPoints.length < 2) return; map.getSource('draw-path').setData({ type: 'Feature', geometry: { type: 'Polygon', coordinates: [[...drawPoints, drawPoints[0]]] } }); }
    function finishDraw() {
        polygonFilter = turf.polygon([[...drawPoints, drawPoints[0]]]);
        map.off('click', handleDrawClick); map.off('dblclick', handleDrawDblClick); map.getCanvas().style.cursor = ''; map.doubleClickZoom.enable();
        filterProjects(); document.getElementById('content2').classList.add('show');
    }
    function clearSpatialFilter() { polygonFilter = null; drawPoints = []; if (map.getSource('draw-path')) map.getSource('draw-path').setData({ type: 'FeatureCollection', features: [] }); filterProjects(); }

function switchStyle(val) {
    map.setStyle(val === 'osm' ? osmStyle : esriStyle);
    
    map.once('style.load', () => {
        // å…ˆæ¸…é™¤èˆŠæ¨™é»
        projectData.forEach(p => { if (p.marker) p.marker.remove(); });
        // é‡æ–°ç”Ÿæˆå¸¶æœ‰æ­£ç¢º zIndex çš„æ¨™é»
        projectData.forEach(p => { p.marker = createProjectMarker(p); });
        // åŸ·è¡Œç¯©é¸é¡¯ç¤º
        filterProjects();

        if (val === 'esri' && map.getLayer('esri-layer')) {
            map.setPaintProperty('esri-layer', 'raster-resampling', 'linear');
        }
    });
}
    function toggleAccordion(h, id) { h.classList.toggle('active'); document.getElementById(id).classList.toggle('show'); }
    function handleSlider() { let s1 = document.getElementById('min-slider'), s2 = document.getElementById('max-slider'); if (parseInt(s1.value) > parseInt(s2.value)) [s1.value, s2.value] = [s2.value, s1.value]; document.getElementById('price-display').innerText = `ç¶“è²»ï¼š${levelNames[s1.value]} ~ ${levelNames[s2.value]}`; filterProjects(); }
    function handleYearSlider() {
    let s1 = document.getElementById('min-year'), s2 = document.getElementById('max-year');
    if (parseInt(s1.value) > parseInt(s2.value)) [s1.value, s2.value] = [s2.value, s1.value];
    document.getElementById('year-display').innerText = `å¹´ä»½ï¼š${s1.value} ~ ${s2.value}`;
    filterProjects(); // è§¸ç™¼ç¯©é¸
}
function handleCityFilter() { if (polygonFilter) clearSpatialFilter(); filterProjects(); }
    function toggleAllTypes(c) { document.querySelectorAll('#type-checkbox-group input').forEach(i => i.checked = c); filterProjects(); }
function exportToCSV() {
    let toExport = projectData.filter(p => p.selected && p.marker.getElement().parentElement);
    // ä¿®æ­£ï¼šèª¿æ•´ç‚ºå°æ‡‰ 17 æ¬„ä½çš„æ–°è®Šæ•¸åç¨±
    let csv = "\ufeffæ¡ˆè™Ÿ,åˆ†é¡,æ¡ˆä»¶ç°¡ç¨±,å¥‘ç´„æ¡ˆå,æ¥­ä¸»,æ‰€åœ¨ä½ç½®,ç¶“è²»,è¨ˆç•«ä¸»æŒäºº\n" + 
              toExport.map(p => `"${p.æ¡ˆè™Ÿ}","${p.åˆ†é¡}","${p.æ¡ˆä»¶ç°¡ç¨±}","${p.å¥‘ç´„æ¡ˆå}","${p.æ¥­ä¸»}","${p.æ‰€åœ¨ä½ç½®}","${p.ç¶“è²»}","${p.è¨ˆç•«ä¸»æŒäºº}"`).join("\n");
    
    let link = document.createElement("a"); 
    link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' })); 
    link.download = "å¯¦ç¸¾åŒ¯æ•´åŒ¯å‡º.csv"; 
    link.click();
}

    const container = document.getElementById('type-checkbox-group');
    for (let cat in categoryColors) { container.innerHTML += `<label class="checkbox-item"><input type="checkbox" value="${cat}" checked onchange="filterProjects()"> ${cat}</label>`; }
async function exportSatelliteImage() {
    if (!polygonFilter) {
        alert("è«‹å…ˆå®Œæˆç¬¬ä¸€éšæ®µçš„ã€Œç¹ªè£½ç¯©é¸å€åŸŸã€ï¼");
        return;
    }

    const statusEl = document.getElementById('status');
    statusEl.style.display = 'block';
    statusEl.innerText = "æ­£åœ¨è¨ˆç®—ç“¦ç‰‡ä¸¦æº–å‚™æ‹¼æ¥åœ–ç‰‡...";

    try {
        // 1. å–å¾—åœˆé¸ç¯„åœçš„é‚Šç•Œ (BBox)
        const bbox = turf.bbox(polygonFilter); // [minLng, minLat, maxLng, maxLat]
        const zoom = 18; // è¨­å®šæœ€ç²¾ç´°å°ºåº¦ (é€šå¸¸ç‚º 18 æˆ– 19)

        // 2. åº§æ¨™è½‰ç“¦ç‰‡ç´¢å¼• (ç¶“ç·¯åº¦è½‰ Tile XYZ)
        const lon2tile = (lon, zoom) => Math.floor((lon + 180) / 360 * Math.pow(2, zoom));
        const lat2tile = (lat, zoom) => Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));

        const startX = lon2tile(bbox[0], zoom);
        const endX = lon2tile(bbox[2], zoom);
        const startY = lat2tile(bbox[3], zoom);
        const endY = lat2tile(bbox[1], zoom);

        const width = (endX - startX + 1) * 256;
        const height = (endY - startY + 1) * 256;

        if (width > 8000 || height > 8000) {
            if (!confirm("ç¯„åœéå¤§ï¼Œç”Ÿæˆçš„åœ–ç‰‡è§£æåº¦æ¥µé«˜ï¼Œå¯èƒ½æœƒé€ æˆç€è¦½å™¨ç•¶æ©Ÿã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ")) {
                statusEl.style.display = 'none';
                return;
            }
        }

        // 3. å»ºç«‹ç•«å¸ƒ
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');

        // 4. ä¸‹è¼‰ä¸¦æ‹¼æ¥ç“¦ç‰‡ (ä½¿ç”¨ Esri è¡›æ˜Ÿåœ–æº)
        const tilePromises = [];
        for (let x = startX; x <= endX; x++) {
            for (let y = startY; y <= endY; y++) {
                const url = `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${y}/${x}`;
                tilePromises.push(new Promise((resolve) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous";
                    img.onload = () => {
                        ctx.drawImage(img, (x - startX) * 256, (y - startY) * 256);
                        resolve();
                    };
                    img.onerror = resolve; // å³ä½¿æŸå¡Šå¤±æ•—ä¹Ÿç¹¼çºŒ
                    img.src = url;
                }));
            }
        }

        await Promise.all(tilePromises);

        // 5. å°å‡ºåœ–ç‰‡
        const link = document.createElement('a');
        link.download = `æƒ‡é™½è¡›æ˜Ÿå½±åƒ_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();

        statusEl.innerText = "åŒ¯å‡ºæˆåŠŸï¼";
        setTimeout(() => statusEl.style.display = 'none', 2000);

    } catch (err) {
        console.error(err);
        alert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¸®å°åœˆé¸ç¯„åœå¾Œå†è©¦ä¸€æ¬¡ã€‚");
        statusEl.style.display = 'none';
    }
}
    loadSpreadsheetData();
async function exportSatelliteImageBatch() {
    if (!polygonFilter) { alert("è«‹å…ˆå®Œæˆç¬¬ä¸€éšæ®µçš„ã€Œç¹ªè£½ç¯©é¸å€åŸŸã€ï¼"); return; }
    const statusEl = document.getElementById('status');
    statusEl.style.display = 'block';
    try {
        const bbox = turf.bbox(polygonFilter); 
        const zoom = 18;
        const lon2tile = (lon, z) => Math.floor((lon + 180) / 360 * Math.pow(2, z));
        const lat2tile = (lat, z) => Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, z));
        
        const startX = lon2tile(bbox[0], zoom);
        const endX = lon2tile(bbox[2], zoom);
        const startY = lat2tile(bbox[3], zoom);
        const endY = lat2tile(bbox[1], zoom);
        
        const maxTilesPerSide = 16; 
        const chunksX = Math.ceil((endX - startX + 1) / maxTilesPerSide);
        const chunksY = Math.ceil((endY - startY + 1) / maxTilesPerSide);

        for (let cy = 0; cy < chunksY; cy++) {
            for (let cx = 0; cx < chunksX; cx++) {
                const cSX = startX + (cx * maxTilesPerSide);
                const cEX = Math.min(startX + ((cx + 1) * maxTilesPerSide) - 1, endX);
                const cSY = startY + (cy * maxTilesPerSide);
                const cEY = Math.min(startY + ((cy + 1) * maxTilesPerSide) - 1, endY);
                
                statusEl.innerText = `æ­£åœ¨è™•ç†ç¬¬ (${cx+1}/${chunksX}, ${cy+1}/${chunksY}) å¼µé«˜æ¸…åœ–...`;
                const canvas = document.createElement('canvas');
                canvas.width = (cEX - cSX + 1) * 256; canvas.height = (cEY - cSY + 1) * 256;
                const ctx = canvas.getContext('2d');
                
                const tilePromises = [];
                for (let x = cSX; x <= cEX; x++) {
                    for (let y = cSY; y <= cEY; y++) {
                        const url = `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${y}/${x}`;
                        tilePromises.push(new Promise((resolve) => {
                            const img = new Image();
                            img.crossOrigin = "Anonymous";
                            img.onload = () => { ctx.drawImage(img, (x - cSX) * 256, (y - cSY) * 256); resolve(); };
                            img.onerror = resolve;
                            img.src = url;
                        }));
                    }
                }
                await Promise.all(tilePromises);
                const link = document.createElement('a');
                link.download = `æƒ‡é™½è¡›æ˜Ÿåœ–_${cx+1}_${cy+1}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                await new Promise(r => setTimeout(r, 800)); // é˜²æ­¢ç€è¦½å™¨é˜»æ“‹
            }
        }
        statusEl.innerText = "æ‰¹é‡åŒ¯å‡ºå®Œæˆï¼";
        setTimeout(() => statusEl.style.display = 'none', 2000);
    } catch (err) { alert("åŒ¯å‡ºå¤±æ•—ã€‚"); statusEl.style.display = 'none'; }
}
</script>
</body>
</html>
