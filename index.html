<!DOCTYPE html>
<html>
<head>
Â  Â  <meta charset="utf-8">
Â  Â  <title>æƒ‡é™½å¯¦ç¸¾åœ°åœ–</title>
Â  Â  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
Â  Â  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
Â  Â  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
Â  Â  <style>
Â  Â  Â  Â  html, body { width: 100%; height: 100%; margin: 0; padding: 0; display: flex; font-family: 'Microsoft JhengHei', sans-serif; overflow: hidden; background: #f0f2f5; }
Â  Â  Â  Â  #map { flex-grow: 1; height: 100%; position: relative; }
Â  Â  Â  Â  #sidebar { width: 420px; height: 100%; background: #ffffff; border-left: 1px solid #ddd; display: flex; flex-direction: column; box-shadow: -2px 0 10px rgba(0,0,0,0.1); z-index: 10; }
Â  Â  Â  Â  .accordion-item { border-bottom: 1px solid #eee; background: #fff; }
Â  Â  Â  Â  .accordion-header { padding: 15px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s; }
Â  Â  Â  Â  .accordion-header.active .arrow-icon { transform: rotate(180deg); }
Â  Â  Â  Â  .section-title { font-size: 14px; font-weight: bold; color: #1A5276; display: flex; align-items: center; margin: 0; }
Â  Â  Â  Â  .section-title::before { content: ""; width: 4px; height: 14px; background: #1A5276; margin-right: 8px; border-radius: 2px; }
Â  Â  Â  Â  .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; background: #fff; }
Â  Â  Â  Â  .accordion-content.show { max-height: 1000px; padding-bottom: 15px; }
Â  Â  Â  Â  .filter-padding { padding: 0 15px; }
Â  Â  Â  Â  .instruction-box { background: #eef2f5; padding: 10px; border-radius: 6px; font-size: 11px; margin-bottom: 10px; color: #555; border-left: 4px solid #FF5722; }
Â  Â  Â  Â  .filter-group { margin-bottom: 10px; }
Â  Â  Â  Â  select, input[type="text"] { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #dfe6e9; box-sizing: border-box; font-size: 13px; }
Â  Â  Â  Â  .checkbox-group { max-height: 160px; overflow-y: auto; border: 1px solid #dfe6e9; border-radius: 6px; padding: 8px; background: #fff; }
Â  Â  Â  Â  .checkbox-item { display: flex; align-items: center; font-size: 12px; margin-bottom: 5px; cursor: pointer; }
Â  Â  Â  Â  .checkbox-item input { margin-right: 8px; width: 16px; height: 16px; }
Â  Â  Â  Â  #result-list { flex-grow: 1; overflow-y: auto; padding: 10px 15px; background: #f8f9fa; }
Â  Â  Â  Â  .result-item { background: white; margin-bottom: 8px; border-radius: 8px; border-left: 6px solid #1A5276; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 10px; }
Â  Â  Â  Â  .item-title { font-size: 13px; font-weight: bold; color: #333; }
Â  Â  Â  Â  .item-subtitle { font-size: 11px; color: #666; margin-top: 4px; }
Â  Â  Â  Â  .map-style-ctrl { position: absolute; top: 10px; left: 10px; z-index: 100; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
Â  Â  Â  Â  .range-slider-container { position: relative; height: 35px; margin-top: 5px; }
Â  Â  Â  Â  .range-slider-container input { position: absolute; width: 100%; pointer-events: none; -webkit-appearance: none; background: none; z-index: 2; }
Â  Â  Â  Â  .range-slider-container input::-webkit-slider-thumb { position: relative; z-index: 5; pointer-events: auto; width: 18px; height: 18px; border-radius: 50%; background: #1A5276; -webkit-appearance: none; cursor: pointer; border: 2px solid #fff; }
Â  Â  Â  Â  .btn-export { background: #27AE60; color: white; border: none; padding: 12px; width: 100%; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; font-size: 14px; }
/* --- CSS é–‹å§‹ --- */

/* 1. å¼·åˆ¶åœ°åœ–å½ˆçª—ï¼ˆPopupï¼‰å±¤ç´šç½®é ‚ï¼Œç¢ºä¿ä¸è¢«åœ“é»è¦†è“‹ */
.maplibregl-popup {
Â  Â  z-index: 999999 !important;Â 
}

.maplibregl-popup-content {
Â  Â  padding: 0 !important; /* ç§»é™¤å…§è·è®“åœ–ç‰‡èˆ‡å‡çµæ¨™é¡Œå¡«æ»¿ */
Â  Â  box-shadow: 0 10px 25px rgba(0,0,0,0.3);
Â  Â  border-radius: 8px;
Â  Â  overflow: hidden;
}

/* 2. å°çª—å…§éƒ¨å®¹å™¨èˆ‡æ»¾å‹•è¨­å®š */
.popup-container {Â 
Â  Â  width: 320px;Â 
Â  Â  font-size: 12px;Â 
Â  Â  line-height: 1.5;Â 
Â  Â  max-height: 450px;Â 
Â  Â  overflow-y: auto;Â 
Â  Â  background: #ffffff;
Â  Â  position: relative;
}

/* 3. æ ¸å¿ƒåŠŸèƒ½ï¼šæ¡ˆåã€ç²çè³‡è¨Šèˆ‡åœ–ç‰‡ é¦–æ¬„å‡çµ */
.sticky-header {
Â  Â  position: sticky;
Â  Â  top: 0;
Â  Â  z-index: 10;
Â  Â  background: #ffffff;
Â  Â  border-bottom: 2px solid #27AE60;
Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.sticky-æ¡ˆå {
Â  Â  padding: 12px 15px 5px 15px;
Â  Â  font-size: 14px;
Â  Â  font-weight: bold;
Â  Â  color: #27AE60;
}

.sticky-ç²ç {
Â  Â  padding: 0 15px 10px 15px;
Â  Â  font-size: 11px;
Â  Â  color: #E67E22;
Â  Â  font-weight: bold;
}

/* 4. åœ–ç‰‡è‡ªå‹•ç¸®æ”¾è‡³æ¡†å…§ */
.popup-container img {Â 
Â  Â  width: 100% !important;Â 
Â  Â  height: auto !important;Â 
Â  Â  display: block;
}

/* 5. è¡¨æ ¼æ’ç‰ˆèˆ‡ç¬¬ä¸€åˆ—å¯¬åº¦ä¿®æ­£ */
.popup-container .content-box { padding: 0 15px 15px 15px; }Â 
.popup-container table { width: 100%; border-collapse: collapse; margin-top: 5px; }
.popup-container td { vertical-align: top; padding: 6px 4px; border-bottom: 1px solid #f0f0f0; }
.popup-container td:first-child {Â 
Â  Â  width: 95px; /* ç¢ºä¿ã€Œè¨ˆç•«ä¸»æŒäººã€ä¸æ›è¡Œ */
Â  Â  color: #666;Â 
Â  Â  font-weight: bold;Â 
Â  Â  background: #fcfcfc;
}

/* --- CSS çµæŸ --- */

/* è‡ªå®šç¾©å‚ç›´æŠ•å½±æŒ‰éˆ•æ¨£å¼ */
.maplibregl-ctrl-pitch {
Â  Â  background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z' fill='%23333'/%3E%3C/svg%3E");
Â  Â  background-size: 20px;
Â  Â  background-repeat: no-repeat;
Â  Â  background-position: center;
}

Â  Â  </style>
</head>
<body>

<div id="status" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9999; background:rgba(0,0,0,0.8); color:white; padding:10px 25px; border-radius:30px;">æ­£åœ¨è®€å–è³‡æ–™...</div>

<div id="map">
<div class="map-style-ctrl">
Â  Â  <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">ğŸ—ºï¸ åœ°åœ–èˆ‡å½±åƒ</div>
Â  Â  <select id="style-selector" onchange="switchStyle(this.value)" style="padding:5px; width: 100%;">
Â  Â  Â  Â  <option value="osm">æ¨™æº–åœ°åœ–</option>
Â  Â  Â  Â  <option value="esri">è¡›æ˜Ÿå½±åƒ</option>
Â  Â  </select>
</div>
</div>

<div id="sidebar">
Â  Â  <div class="accordion-item">
Â  Â  Â  Â  <div class="accordion-header active" onclick="toggleAccordion(this, 'content1')">
Â  Â  Â  Â  Â  Â  <h3 class="section-title">ç¬¬ä¸€éšæ®µï¼šç©ºé–“ç¯©é¸</h3><span class="arrow-icon">â–¼</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="content1" class="accordion-content show">
Â  Â  Â  Â  Â  Â  <div class="filter-padding">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="instruction-box">ğŸ’¡ å–®æ“Šæ–°å¢é»ï¼Œé›™æ“ŠçµæŸé–‰åˆå€åŸŸã€‚</div>
Â  Â  Â  Â  Â  Â  Â  Â  <button style="background:#1A5276; color:white; border:none; padding:10px; width:100%; border-radius:6px; cursor:pointer; font-weight:bold;" onclick="startDraw()">ğŸ“ ç¹ªè£½ç¯©é¸å€åŸŸ</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button style="background:#b2bec3; color:white; border:none; padding:5px; width:100%; border-radius:6px; cursor:pointer; margin-top:5px; font-size:11px;" onclick="clearSpatialFilter()">âœ• æ¸…é™¤å€åŸŸ</button>
Â  Â  Â  Â  Â  Â  Â  Â  <select id="city-filter" onchange="handleCityFilter()" style="margin-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="å…¨åœ‹">--- ç¸£å¸‚è·³è½‰ ---</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="accordion-item">
Â  Â  Â  Â  <div class="accordion-header" id="header2" onclick="toggleAccordion(this, 'content2')">
Â  Â  Â  Â  Â  Â  <h3 class="section-title">ç¬¬äºŒéšæ®µï¼šå±¬æ€§ç¯©é¸</h3><span class="arrow-icon">â–¼</span>
Â  Â  Â  Â  </div>
<div id="content2" class="accordion-content show">
Â  Â  <div class="filter-padding">
Â  Â  Â  Â  <div class="checkbox-group" id="type-checkbox-group"></div>
Â  Â  Â  Â  <input type="text" id="search-input" placeholder="ğŸ” æœå°‹ (æ¡ˆè™Ÿã€ç°¡ç¨±ã€ä¸»æŒäºº)" oninput="filterProjects()" style="margin-top:10px;">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="price-display" style="font-size:11px; color:#1A5276; margin-top:10px; text-align:center;">ç¶“è²»ï¼š0 ~ 5å„„+</div>
Â  Â  Â  Â  <div class="range-slider-container">
Â  Â  Â  Â  Â  Â  <input type="range" id="min-slider" min="0" max="6" value="0" oninput="handleSlider()">
Â  Â  Â  Â  Â  Â  <input type="range" id="max-slider" min="0" max="6" value="6" oninput="handleSlider()">
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="filter-group" style="margin-top:15px;">
Â  Â  Â  Â  Â  Â  <div id="start-year-display" style="font-size:11px; color:#E67E22; text-align:center; font-weight:bold;">é–‹å§‹å¹´ä»½ï¼š2010 ä»¥ä¸Š</div>
Â  Â  Â  Â  Â  Â  <div class="range-slider-container">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="range" id="filter-start-year" min="2010" max="2026" value="2010" oninput="handleDateFilter()">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div id="end-year-display" style="font-size:11px; color:#E67E22; margin-top:10px; text-align:center; font-weight:bold;">çµæŸå¹´ä»½ï¼š2026 ä»¥ä¸‹</div>
Â  Â  Â  Â  Â  Â  <div class="range-slider-container">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="range" id="filter-end-year" min="2010" max="2026" value="2026" oninput="handleDateFilter()">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <button class="btn-export" onclick="exportToCSV()">ğŸ“Š åŒ¯å‡ºæ‰€é¸ CSV</button>
Â  Â  Â  Â  <button class="btn-export" style="background: #E67E22; margin-top: 5px;" onclick="exportSatelliteImageBatch()">ğŸ–¼ï¸ æ‰¹é‡åŒ¯å‡ºé«˜æ¸…è¡›æ˜Ÿåœ–</button>
Â  Â  </div>
</div>
Â  Â  </div>
Â  Â  <div id="result-count" style="font-size:12px; color:#1A5276; padding:10px; background:#eef2f5; font-weight:bold;">ç¬¦åˆï¼š0 ç­†</div>
Â  Â  <div id="result-list"></div>
</div>

<script>
Â  Â  // 12 ç¨®é¡åˆ¥é¡è‰²å®šç¾©
Â  Â  const categoryColors = {
Â  Â  Â  Â  "ç”¢æ¥­åœ’å€é–‹ç™¼": "#E74C3C", "éƒ½å¸‚è¨ˆç•«åŠéƒ½å¸‚æ›´æ–°": "#8E44AD", "åœ‹åœŸè¨ˆç•«åŠééƒ½å¸‚åœŸåœ°é–‹ç™¼": "#2E86C1",
Â  Â  Â  Â  "å¤ªé™½èƒ½åŸºåœ°è¨­è¨ˆ": "#F1C40F", "ä¿ƒåƒæ‹›å•†": "#16A085", "éŠæ†©è¦åŠƒ": "#FF1493",
Â  Â  Â  Â  "å»ºç¯‰è¨­è¨ˆ": "#00CED1", "æ™¯è§€è¨­è¨ˆ": "#27AE60", "éŠæˆ²å ´è¨­è¨ˆ": "#E67E22",
Â  Â  Â  Â  "VSCAPE è¶Šå—æ™¯è§€è¨­è¨ˆ": "#D35400", "éƒ½å¸‚è¨­è¨ˆ": "#7F8C8D", "å°ˆæ¡ˆç®¡ç†": "#2C3E50"
Â  Â  };

Â  Â  const terrainRGB = { "type": "raster-dem", "tiles": ["https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png"], "encoding": "terrarium", "tileSize": 256 };
Â  Â  const buildings = { "type": "vector", "tiles": ["https://{s}.data.osmbuildings.org/0.2/59f80695/tile/{z}/{x}/{y}.json"] };

Â  Â  const osmStyle = {
Â  Â  Â  Â  "version": 8,
Â  Â  Â  Â  "sources": {
Â  Â  Â  Â  Â  Â  "osm": { "type": "raster", "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize": 256 },
Â  Â  Â  Â  Â  Â  "osm-buildings": buildings,
Â  Â  Â  Â  Â  Â  "t-rgb": terrainRGB
Â  Â  Â  Â  },
Â  Â  Â  Â  "layers": [
Â  Â  Â  Â  Â  Â  { "id": "osm-layer", "type": "raster", "source": "osm" },
Â  Â  Â  Â  Â  Â  { "id": "3d-buildings", "type": "fill-extrusion", "source": "osm-buildings", "source-layer": "building", "paint": { "fill-extrusion-color": "#fff", "fill-extrusion-height": ["get", "height"], "fill-extrusion-opacity": 0.6 } }
Â  Â  Â  Â  ],
Â  Â  Â  Â  "terrain": { "source": "t-rgb", "exaggeration": 1.2 }
Â  Â  };

const esriStyle = {
Â  Â  "version": 8,
Â  Â  "sources": {
Â  Â  Â  Â  "esri": {Â 
Â  Â  Â  Â  Â  Â  "type": "raster",Â 
Â  Â  Â  Â  Â  Â  "tiles": ["https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"],Â 
Â  Â  Â  Â  Â  Â  "tileSize": 256, // ä¿æŒ 256 æˆ–è©¦è‘—æ”¹ç‚º 512 è§€å¯Ÿè‰²å·®
Â  Â  Â  Â  Â  Â  "attribution": "Esri"Â 
Â  Â  Â  Â  },
Â  Â  Â  Â  "t-rgb": terrainRGB
Â  Â  },
Â  Â  "layers": [{ "id": "esri-layer", "type": "raster", "source": "esri" }],
Â  Â  "terrain": { "source": "t-rgb", "exaggeration": 1 }
};
Â  Â  var map = new maplibregl.Map({ container: 'map', style: osmStyle, center: [121.0, 23.8], zoom: 7, pitch: 45 });
Â  Â  map.addControl(new maplibregl.NavigationControl());
map.on('click', (e) => {});
// åœ¨åŸç”Ÿçš„ NavigationControl å®¹å™¨ä¸­æ’å…¥æŒ‰éˆ•
const navGroup = document.querySelector('.maplibregl-ctrl-group');
if (navGroup) {
Â  Â  // 1. å‚ç›´æŠ•å½±æŒ‰éˆ•
Â  Â  const pitchBtn = document.createElement('button');
Â  Â  pitchBtn.className = 'maplibregl-ctrl-icon maplibregl-ctrl-pitch';
Â  Â  pitchBtn.type = 'button';
Â  Â  pitchBtn.title = 'æ¢å¾©å‚ç›´æŠ•å½± (2D)';
Â  Â  pitchBtn.onclick = () => map.easeTo({ pitch: 0 });
Â  Â  navGroup.appendChild(pitchBtn);

Â  Â  // 2. é–‹é—œç«‹é«”åœ°å½¢æŒ‰éˆ•
Â  Â  let terrainEnabled = true; // é è¨­é–‹å•Ÿ
Â  Â  const terrainBtn = document.createElement('button');
Â  Â  terrainBtn.className = 'maplibregl-ctrl-icon maplibregl-ctrl-terrain';
Â  Â  terrainBtn.type = 'button';
Â  Â  terrainBtn.title = 'é–‹å•Ÿ/é—œé–‰ç«‹é«”åœ°å½¢';
Â  Â  terrainBtn.innerHTML = 'â›°ï¸'; // ä½¿ç”¨ Emoji æˆ–è‡ªå®šç¾©åœ–ç¤º
Â  Â  terrainBtn.style.fontSize = '16px';
Â  Â Â 
Â  Â  terrainBtn.onclick = () => {
Â  Â  Â  Â  terrainEnabled = !terrainEnabled;
Â  Â  Â  Â  if (terrainEnabled) {
Â  Â  Â  Â  Â  Â  // é‡æ–°å•Ÿç”¨åœ°å½¢ (ä½¿ç”¨å®šç¾©å¥½çš„æ•¸æ“šæº)
Â  Â  Â  Â  Â  Â  map.setTerrain({ 'source': 't-rgb', 'exaggeration': 1.5 });
Â  Â  Â  Â  Â  Â  terrainBtn.style.background = '#eee'; // æŒ‰ä¸‹ç‹€æ…‹
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  // é—œé–‰åœ°å½¢
Â  Â  Â  Â  Â  Â  map.setTerrain(null);
Â  Â  Â  Â  Â  Â  terrainBtn.style.background = '#fff';
Â  Â  Â  Â  }
Â  Â  };
Â  Â  navGroup.appendChild(terrainBtn);
}
Â  Â  var projectData = [];
Â  Â  var polygonFilter = null;
Â  Â  const levelNames = ["0", "100è¬", "1000è¬", "5000è¬", "1å„„", "5å„„", "5å„„+"];
Â  Â  const levels = [0, 1e6, 1e7, 5e7, 1e8, 5e8, 1e12];

Â  Â  function loadSpreadsheetData() {
Â  Â  const ssId = "19GZRlk-nx6xR-EL3JtS6bBrB_POCPIQgQdeKVN5O7C8";
Â  Â  const sheets = Object.keys(categoryColors);
Â  Â  let loaded = 0;
Â  Â  sheets.forEach((name, idx) => {
Â  Â  Â  Â  const cbName = `cb_${idx}`;
Â  Â  Â  Â  window[cbName] = (json) => {
Â  Â  Â  Â  Â  Â  if (json.table) {
Â  Â  Â  Â  Â  Â  Â  Â  json.table.rows.forEach(row => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const get = (i) => (row.c && row.c[i]) ? (row.c[i].f || row.c[i].v || "") : "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let wkt = String(get(0));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!wkt || wkt.includes("åº§æ¨™") || wkt === "--") return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ä¾åºæŠ“å– 17 å€‹æ¬„ä½ (A-Q)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  projectData.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  wkt: wkt,Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // A: åº§æ¨™
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  æ¡ˆè™Ÿ: get(1),Â  Â  Â  Â  Â  Â  Â  Â  // B
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  æ¡ˆä»¶ç°¡ç¨±: get(2),Â  Â  Â  Â  Â  Â  // C
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  å¥‘ç´„æ¡ˆå: get(3),Â  Â  Â  Â  Â  Â  // D
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  å·¥ç¨‹åç¨±: get(4),Â  Â  Â  Â  Â  Â  // E
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  æ¥­ä¸»: get(5),Â  Â  Â  Â  Â  Â  Â  Â  // F
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  æ‰€åœ¨ä½ç½®: get(6),Â  Â  Â  Â  Â  Â  // G
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  é¢ç©è¦æ¨¡: get(7),Â  Â  Â  Â  Â  Â  // H
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ç¶“è²»: get(8),Â  Â  Â  Â  Â  Â  Â  Â  // I
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ç¶“è²»å€¼: parseFloat(String(get(8)).replace(/[^0-9.]/g, "")) || 0,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  å¯¦ç¸¾ç…§ç‰‡: get(9),Â  Â  Â  Â  Â  Â  // J
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  æ¡ˆä»¶å±¬æ€§: get(10),Â  Â  Â  Â  Â  Â // K
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ç²çè³‡è¨Š: get(11),Â  Â  Â  Â  Â  Â // L
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  åŸ·è¡Œçµ„åˆ¥: get(12),Â  Â  Â  Â  Â  Â // M
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  è¨ˆç•«ä¸»æŒäºº: get(13),Â  Â  Â  Â  Â // N
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  é—œéµæ³•æ¢: get(14),Â  Â  Â  Â  Â  Â // O
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  èµ·è¨–æ—¥æœŸ: get(15),Â  Â  Â  Â  Â  Â // P
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  å‚™è¨»: get(16),Â  Â  Â  Â  Â  Â  Â  Â // Q
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  åˆ†é¡: name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ç¸£å¸‚: String(get(6)).substring(0, 3),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  selected: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (++loaded === sheets.length) finalize();
Â  Â  Â  Â  };
Â  Â  Â  Â  const s = document.createElement('script');
Â  Â  Â  Â  s.src = `https://docs.google.com/spreadsheets/d/${ssId}/gviz/tq?tqx=responseHandler:${cbName}&sheet=${encodeURIComponent(name)}`;
Â  Â  Â  Â  document.body.appendChild(s);
Â  Â  });
}

Â  Â  function finalize() {
Â  Â  Â  Â  document.getElementById('status').style.display = 'none';
Â  Â  Â  Â  const cities = [...new Set(projectData.map(p => p.ç¸£å¸‚))].filter(c => c.length >= 2).sort();
Â  Â  Â  Â  cities.forEach(c => document.getElementById('city-filter').innerHTML += `<option value="${c}">${c}</option>`);
Â  Â  Â  Â  projectData.forEach(p => { p.marker = createProjectMarker(p); });
Â  Â  Â  Â  filterProjects();
Â  Â  }

function createProjectMarker(p) {
Â  Â  let coords = parseWKT(p.wkt);
Â  Â  if (!coords) return null;
Â  Â  const el = document.createElement('div');
Â  Â  const color = categoryColors[p.åˆ†é¡] || "#333";
Â  Â Â 
Â  Â  // è¨­å®šé»ä½æ¨£å¼ï¼ŒzIndex è¨­ç‚º 0
Â  Â  el.style.width = '14px';
Â  Â  el.style.height = '14px';
Â  Â  el.style.backgroundColor = color;
Â  Â  el.style.borderRadius = '50%';
Â  Â  el.style.border = '2px solid #ffffff';
Â  Â  el.style.cursor = 'pointer';
Â  Â  el.style.zIndex = '0'; // é»ä½å±¤ç´šæœ€ä½
Â  Â  el.style.boxShadow = '0 0 6px rgba(0,0,0,0.6)';

Â  Â  let imageUrl = p.å¯¦ç¸¾ç…§ç‰‡;
Â  Â  if (imageUrl && imageUrl.includes('drive.google.com')) {
Â  Â  Â  Â  const fileIdMatch = imageUrl.match(/[-\w]{25,}/);
Â  Â  Â  Â  if (fileIdMatch) imageUrl = `https://drive.google.com/thumbnail?authuser=0&sz=w1000&id=${fileIdMatch[0]}`;
Â  Â  }
let startDate = "--";
let endDate = "--";
if (p.èµ·è¨–æ—¥æœŸ && p.èµ·è¨–æ—¥æœŸ.includes('-')) {
Â  Â  const parts = p.èµ·è¨–æ—¥æœŸ.split('-');
Â  Â  startDate = parts[0].trim();
Â  Â  endDate = parts[1].trim();
} else if (p.èµ·è¨–æ—¥æœŸ) {
Â  Â  startDate = p.èµ·è¨–æ—¥æœŸ;
}
// é‡æ–°ç·¨æ’ HTMLï¼šæ¡ˆåèˆ‡åœ–ç‰‡ç½®é ‚å‡çµ
const popupHtml = `
Â  Â  <div class="popup-container">
Â  Â  Â  Â  <div class="sticky-header">
Â  Â  Â  Â  Â  Â  <div class="sticky-æ¡ˆå">${p.å¥‘ç´„æ¡ˆå || p.æ¡ˆä»¶ç°¡ç¨±}</div>
Â  Â  Â  Â  Â  Â  ${p.ç²çè³‡è¨Š ? `<div class="sticky-ç²ç">ğŸ† ${p.ç²çè³‡è¨Š}</div>` : ''}
Â  Â  Â  Â  Â  Â  ${imageUrl ? `<img src="${imageUrl}" onerror="this.style.display='none'">` : ''}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="content-box">
<table>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>æ¡ˆè™Ÿ</td><td>${p.æ¡ˆè™Ÿ}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>æ¡ˆä»¶ç°¡ç¨±</td><td>${p.æ¡ˆä»¶ç°¡ç¨±}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>å·¥ç¨‹åç¨±</td><td>${p.å·¥ç¨‹åç¨±}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>æ¥­ä¸»</td><td>${p.æ¥­ä¸»}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>é–‹å§‹æ—¥æœŸ</td><td>${startDate}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>çµæŸæ—¥æœŸ</td><td>${endDate}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>æ‰€åœ¨ä½ç½®</td><td>${p.æ‰€åœ¨ä½ç½®}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>é¢ç©è¦æ¨¡</td><td>${p.é¢ç©è¦æ¨¡}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>ç¶“è²»</td><td>${p.ç¶“è²»}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>åŸ·è¡Œçµ„åˆ¥</td><td>${p.åŸ·è¡Œçµ„åˆ¥}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>è¨ˆç•«ä¸»æŒäºº</td><td>${p.è¨ˆç•«ä¸»æŒäºº}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>é—œéµæ³•æ¢</td><td>${p.é—œéµæ³•æ¢}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>å‚™è¨»</td><td>${p.å‚™è¨»}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>å¯¦ç¸¾åˆ†é¡</td><td>${p.åˆ†é¡}</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>`;
// å»ºç«‹æ¨™é»ä½†ä¸é å…ˆè¨­ç½® Popup
Â  Â  const marker = new maplibregl.Marker({ element: el, anchor: 'center' }).setLngLat(coords);

Â  Â  // å¯¦ä½œã€Œé»æ“Šæ–°æ¡ˆä»¶ã€é—œé–‰èˆŠå°çª—ã€çš„é‚è¼¯
Â  Â  el.addEventListener('click', (e) => {
Â  Â  Â  Â  e.stopPropagation(); // é˜²æ­¢åœ°åœ–é»æ“Šäº‹ä»¶å¹²æ“¾
Â  Â  Â  Â Â 
Â  Â  Â  Â  // 1. å…ˆé—œé–‰å…¨åœ°åœ–æ‰€æœ‰ç¾æœ‰çš„ Popup
Â  Â  Â  Â  const activePopups = document.getElementsByClassName('maplibregl-popup');
Â  Â  Â  Â  while (activePopups[0]) { activePopups[0].remove(); }

Â  Â  Â  Â  // 2. åœ¨è©²é»ä½ä¸Šæ–¹é–‹å•Ÿæ–°çš„ Popup
Â  Â  Â  Â  new maplibregl.Popup({
Â  Â  Â  Â  offset: 35, // å¢åŠ åç§»é‡ï¼Œç¢ºä¿å®Œå…¨é¿é–‹é»ä½ä¸­å¿ƒ
Â  Â  Â  Â  maxWidth: '340px',
Â  Â  Â  Â  anchor: 'bottom',
Â  Â  Â  Â  closeButton: true,
Â  Â  Â  Â  closeOnClick: trueÂ 
})
Â  Â  Â  Â  .setLngLat(coords)
Â  Â  Â  Â  .setHTML(popupHtml)
Â  Â  Â  Â  .addTo(map);
});
return marker;
}
function handleDateFilter() {
Â  Â  const startV = document.getElementById('filter-start-year').value;
Â  Â  const endV = document.getElementById('filter-end-year').value;
Â  Â  document.getElementById('start-year-display').innerText = `é–‹å§‹å¹´ä»½ï¼š${startV} ä»¥ä¸Š`;
Â  Â  document.getElementById('end-year-display').innerText = `çµæŸå¹´ä»½ï¼š${endV} ä»¥ä¸‹`;
Â  Â  filterProjects();
}
Â  Â  function parseWKT(wkt) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  let match = wkt.includes("POINT") ? wkt.match(/\(([^)]+)\)/)[1].trim().split(/\s+/) : wkt.match(/\(\(([^,]+)/)[1].trim().split(/\s+/);
Â  Â  Â  Â  Â  Â  return [parseFloat(match[0]), parseFloat(match[1])];
Â  Â  Â  Â  } catch(e) { return null; }
Â  Â  }

Â  Â  function toggleSelect(e, i) {
Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  projectData[i].selected = e.target.checked;
Â  Â  Â  Â  if (projectData[i].selected) projectData[i].marker.addTo(map);
Â  Â  Â  Â  else projectData[i].marker.remove();
Â  Â  }

// --- JavaScript é–‹å§‹ ---

function filterProjects() {
Â  Â  const city = document.getElementById('city-filter').value;
Â  Â  const searchStr = document.getElementById('search-input').value.toLowerCase();
Â  Â  const minV = levels[document.getElementById('min-slider').value];
Â  Â  const maxV = levels[document.getElementById('max-slider').value];
Â  Â  const checkedTypes = Array.from(document.querySelectorAll('#type-checkbox-group input:checked')).map(el => el.value);
Â  Â  const list = document.getElementById('result-list');
Â  Â Â 
Â  Â  // ä¿®æ­£ï¼šæŠ“å–æ‹†åˆ†å¾Œçš„å¹´ä»½å€¼
Â  Â  const filterStartY = parseInt(document.getElementById('filter-start-year').value);
Â  Â  const filterEndY = parseInt(document.getElementById('filter-end-year').value);
Â  Â Â 
Â  Â  list.innerHTML = '';
Â  Â  let count = 0; // é—œéµä¿®æ­£ï¼šåˆå§‹åŒ–è¨ˆæ•¸å™¨
Â  Â  projectData.forEach((p, index) => {
Â  Â  Â  Â  if (!p.marker) return;
Â  Â  Â  Â  let mSpatial = polygonFilter ? turf.booleanPointInPolygon(turf.point(p.marker.getLngLat().toArray()), polygonFilter) : (city === "å…¨åœ‹" || p.ç¸£å¸‚ === city);
Â  Â  Â  Â  let mType = checkedTypes.includes(p.åˆ†é¡);
Â  Â  Â  Â  let mPrice = (p.ç¶“è²»å€¼ >= minV && p.ç¶“è²»å€¼ <= maxV);
Â  Â  Â  Â  let mSearch = !searchStr || (p.æ¡ˆä»¶ç°¡ç¨± + p.æ¥­ä¸» + p.è¨ˆç•«ä¸»æŒäºº + p.æ¡ˆè™Ÿ).toLowerCase().includes(searchStr);
let mYearMatch = true;
Â  Â  Â  Â  if (p.èµ·è¨–æ—¥æœŸ && p.èµ·è¨–æ—¥æœŸ.includes('.')) {
Â  Â  Â  Â  Â  Â  const years = p.èµ·è¨–æ—¥æœŸ.match(/\d{4}/g);Â 
Â  Â  Â  Â  Â  Â  if (years && years.length >= 1) {
Â  Â  Â  Â  Â  Â  Â  Â  const projectStart = parseInt(years[0]);
Â  Â  Â  Â  Â  Â  Â  Â  const projectEnd = years.length > 1 ? parseInt(years[1]) : projectStart;

Â  Â  Â  Â  Â  Â  Â  Â  // åš´æ ¼ç¯©é¸ï¼šé–‹å§‹æ™‚é–“å¿…é ˆåœ¨ç¯„åœå¾Œï¼ŒçµæŸæ™‚é–“å¿…é ˆåœ¨ç¯„åœå‰
Â  Â  Â  Â  Â  Â  Â  Â  mYearMatch = (projectStart >= filterStartY && projectEnd <= filterEndY);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
if (mSpatial && mType && mPrice && mSearch && mYearMatch) {
Â  Â  Â  Â  Â  Â  count++;
Â  Â  Â  Â  Â  Â  if (p.selected) p.marker.addTo(map); else p.marker.remove();
Â  Â  Â  Â  Â  Â  let div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.className = 'result-item'; div.style.borderLeft = `6px solid ${categoryColors[p.åˆ†é¡]}`;
Â  Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="display:flex;align-items:center;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" ${p.selected?'checked':''} onclick="toggleSelect(event,${index})" style="margin-right:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="flex:1" onclick="map.flyTo({center:[${p.marker.getLngLat().lng},${p.marker.getLngLat().lat}],zoom:16,pitch:65}); p.marker.togglePopup()">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-title">${p.æ¡ˆä»¶ç°¡ç¨±}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="item-subtitle">${p.æ¥­ä¸»}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  list.appendChild(div);
Â  Â  Â  Â  } else { p.marker.remove(); }
Â  Â  });
Â  Â  document.getElementById('result-count').innerText = `ç¬¦åˆï¼š ${count} ç­†`;
}
Â  Â  // ç¹ªè£½åŠŸèƒ½
Â  Â  let drawPoints = [];
Â  Â  function startDraw() {
Â  Â  Â  Â  drawPoints = []; clearSpatialFilter(); map.getCanvas().style.cursor = 'crosshair';
Â  Â  Â  Â  if (!map.getSource('draw-path')) {
Â  Â  Â  Â  Â  Â  map.addSource('draw-path', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
Â  Â  Â  Â  Â  Â  map.addLayer({ id: 'draw-fill', type: 'fill', source: 'draw-path', paint: { 'fill-color': '#FF5722', 'fill-opacity': 0.3 } });
Â  Â  Â  Â  Â  Â  map.addLayer({ id: 'draw-line', type: 'line', source: 'draw-path', paint: { 'line-color': '#FF5722', 'line-width': 5, 'line-dasharray': [1,1] } });
Â  Â  Â  Â  }
Â  Â  Â  Â  map.on('click', handleDrawClick); map.on('dblclick', handleDrawDblClick); map.doubleClickZoom.disable();
Â  Â  }
Â  Â  function handleDrawClick(e) { drawPoints.push([e.lngLat.lng, e.lngLat.lat]); updateDraw(); }
Â  Â  function handleDrawDblClick(e) { e.originalEvent.preventDefault(); if (drawPoints.length >= 3) finishDraw(); }
Â  Â  function updateDraw() { if (drawPoints.length < 2) return; map.getSource('draw-path').setData({ type: 'Feature', geometry: { type: 'Polygon', coordinates: [[...drawPoints, drawPoints[0]]] } }); }
Â  Â  function finishDraw() {
Â  Â  Â  Â  polygonFilter = turf.polygon([[...drawPoints, drawPoints[0]]]);
Â  Â  Â  Â  map.off('click', handleDrawClick); map.off('dblclick', handleDrawDblClick); map.getCanvas().style.cursor = ''; map.doubleClickZoom.enable();
Â  Â  Â  Â  filterProjects(); document.getElementById('content2').classList.add('show');
Â  Â  }
Â  Â  function clearSpatialFilter() { polygonFilter = null; drawPoints = []; if (map.getSource('draw-path')) map.getSource('draw-path').setData({ type: 'FeatureCollection', features: [] }); filterProjects(); }

function switchStyle(val) {
Â  Â  map.setStyle(val === 'osm' ? osmStyle : esriStyle);
Â  Â Â 
Â  Â  map.once('style.load', () => {
Â  Â  Â  Â  // å…ˆæ¸…é™¤èˆŠæ¨™é»
Â  Â  Â  Â  projectData.forEach(p => { if (p.marker) p.marker.remove(); });
Â  Â  Â  Â  // é‡æ–°ç”Ÿæˆå¸¶æœ‰æ­£ç¢º zIndex çš„æ¨™é»
Â  Â  Â  Â  projectData.forEach(p => { p.marker = createProjectMarker(p); });
Â  Â  Â  Â  // åŸ·è¡Œç¯©é¸é¡¯ç¤º
Â  Â  Â  Â  filterProjects();

Â  Â  Â  Â  if (val === 'esri' && map.getLayer('esri-layer')) {
Â  Â  Â  Â  Â  Â  map.setPaintProperty('esri-layer', 'raster-resampling', 'linear');
Â  Â  Â  Â  }
Â  Â  });
}
Â  Â  function toggleAccordion(h, id) { h.classList.toggle('active'); document.getElementById(id).classList.toggle('show'); }
Â  Â  function handleSlider() { let s1 = document.getElementById('min-slider'), s2 = document.getElementById('max-slider'); if (parseInt(s1.value) > parseInt(s2.value)) [s1.value, s2.value] = [s2.value, s1.value]; document.getElementById('price-display').innerText = `ç¶“è²»ï¼š${levelNames[s1.value]} ~ ${levelNames[s2.value]}`; filterProjects(); }
Â  Â  function handleYearSlider() {
Â  Â  let s1 = document.getElementById('min-year'), s2 = document.getElementById('max-year');
Â  Â  if (parseInt(s1.value) > parseInt(s2.value)) [s1.value, s2.value] = [s2.value, s1.value];
Â  Â  document.getElementById('year-display').innerText = `å¹´ä»½ï¼š${s1.value} ~ ${s2.value}`;
Â  Â  filterProjects(); // è§¸ç™¼ç¯©é¸
}
function handleCityFilter() { if (polygonFilter) clearSpatialFilter(); filterProjects(); }
Â  Â  function toggleAllTypes(c) { document.querySelectorAll('#type-checkbox-group input').forEach(i => i.checked = c); filterProjects(); }
function exportToCSV() {
Â  Â  let toExport = projectData.filter(p => p.selected && p.marker.getElement().parentElement);
Â  Â  // ä¿®æ­£ï¼šèª¿æ•´ç‚ºå°æ‡‰ 17 æ¬„ä½çš„æ–°è®Šæ•¸åç¨±
Â  Â  let csv = "\ufeffæ¡ˆè™Ÿ,åˆ†é¡,æ¡ˆä»¶ç°¡ç¨±,å¥‘ç´„æ¡ˆå,æ¥­ä¸»,æ‰€åœ¨ä½ç½®,ç¶“è²»,è¨ˆç•«ä¸»æŒäºº\n" +Â 
Â  Â  Â  Â  Â  Â  Â  toExport.map(p => `"${p.æ¡ˆè™Ÿ}","${p.åˆ†é¡}","${p.æ¡ˆä»¶ç°¡ç¨±}","${p.å¥‘ç´„æ¡ˆå}","${p.æ¥­ä¸»}","${p.æ‰€åœ¨ä½ç½®}","${p.ç¶“è²»}","${p.è¨ˆç•«ä¸»æŒäºº}"`).join("\n");
Â  Â Â 
Â  Â  let link = document.createElement("a");Â 
Â  Â  link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));Â 
Â  Â  link.download = "å¯¦ç¸¾åŒ¯æ•´åŒ¯å‡º.csv";Â 
Â  Â  link.click();
}

Â  Â  const container = document.getElementById('type-checkbox-group');
Â  Â  for (let cat in categoryColors) { container.innerHTML += `<label class="checkbox-item"><input type="checkbox" value="${cat}" checked onchange="filterProjects()"> ${cat}</label>`; }
async function exportSatelliteImage() {
Â  Â  if (!polygonFilter) {
Â  Â  Â  Â  alert("è«‹å…ˆå®Œæˆç¬¬ä¸€éšæ®µçš„ã€Œç¹ªè£½ç¯©é¸å€åŸŸã€ï¼");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  const statusEl = document.getElementById('status');
Â  Â  statusEl.style.display = 'block';
Â  Â  statusEl.innerText = "æ­£åœ¨è¨ˆç®—ç“¦ç‰‡ä¸¦æº–å‚™æ‹¼æ¥åœ–ç‰‡...";

Â  Â  try {
Â  Â  Â  Â  // 1. å–å¾—åœˆé¸ç¯„åœçš„é‚Šç•Œ (BBox)
Â  Â  Â  Â  const bbox = turf.bbox(polygonFilter); // [minLng, minLat, maxLng, maxLat]
Â  Â  Â  Â  const zoom = 18; // è¨­å®šæœ€ç²¾ç´°å°ºåº¦ (é€šå¸¸ç‚º 18 æˆ– 19)

Â  Â  Â  Â  // 2. åº§æ¨™è½‰ç“¦ç‰‡ç´¢å¼• (ç¶“ç·¯åº¦è½‰ Tile XYZ)
Â  Â  Â  Â  const lon2tile = (lon, zoom) => Math.floor((lon + 180) / 360 * Math.pow(2, zoom));
Â  Â  Â  Â  const lat2tile = (lat, zoom) => Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, zoom));

Â  Â  Â  Â  const startX = lon2tile(bbox[0], zoom);
Â  Â  Â  Â  const endX = lon2tile(bbox[2], zoom);
Â  Â  Â  Â  const startY = lat2tile(bbox[3], zoom);
Â  Â  Â  Â  const endY = lat2tile(bbox[1], zoom);

Â  Â  Â  Â  const width = (endX - startX + 1) * 256;
Â  Â  Â  Â  const height = (endY - startY + 1) * 256;

Â  Â  Â  Â  if (width > 8000 || height > 8000) {
Â  Â  Â  Â  Â  Â  if (!confirm("ç¯„åœéå¤§ï¼Œç”Ÿæˆçš„åœ–ç‰‡è§£æåº¦æ¥µé«˜ï¼Œå¯èƒ½æœƒé€ æˆç€è¦½å™¨ç•¶æ©Ÿã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿ")) {
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // 3. å»ºç«‹ç•«å¸ƒ
Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  canvas.width = width;
Â  Â  Â  Â  canvas.height = height;
Â  Â  Â  Â  const ctx = canvas.getContext('2d');

Â  Â  Â  Â  // 4. ä¸‹è¼‰ä¸¦æ‹¼æ¥ç“¦ç‰‡ (ä½¿ç”¨ Esri è¡›æ˜Ÿåœ–æº)
Â  Â  Â  Â  const tilePromises = [];
Â  Â  Â  Â  for (let x = startX; x <= endX; x++) {
Â  Â  Â  Â  Â  Â  for (let y = startY; y <= endY; y++) {
Â  Â  Â  Â  Â  Â  Â  Â  const url = `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${y}/${x}`;
Â  Â  Â  Â  Â  Â  Â  Â  tilePromises.push(new Promise((resolve) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.crossOrigin = "Anonymous";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.onload = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ctx.drawImage(img, (x - startX) * 256, (y - startY) * 256);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.onerror = resolve; // å³ä½¿æŸå¡Šå¤±æ•—ä¹Ÿç¹¼çºŒ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.src = url;
Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  await Promise.all(tilePromises);

Â  Â  Â  Â  // 5. å°å‡ºåœ–ç‰‡
Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  link.download = `æƒ‡é™½è¡›æ˜Ÿå½±åƒ_${new Date().getTime()}.png`;
Â  Â  Â  Â  link.href = canvas.toDataURL("image/png");
Â  Â  Â  Â  link.click();

Â  Â  Â  Â  statusEl.innerText = "åŒ¯å‡ºæˆåŠŸï¼";
Â  Â  Â  Â  setTimeout(() => statusEl.style.display = 'none', 2000);

Â  Â  } catch (err) {
Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  alert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¸®å°åœˆé¸ç¯„åœå¾Œå†è©¦ä¸€æ¬¡ã€‚");
Â  Â  Â  Â  statusEl.style.display = 'none';
Â  Â  }
}
Â  Â  loadSpreadsheetData();
async function exportSatelliteImageBatch() {
Â  Â  if (!polygonFilter) { alert("è«‹å…ˆå®Œæˆç¬¬ä¸€éšæ®µçš„ã€Œç¹ªè£½ç¯©é¸å€åŸŸã€ï¼"); return; }
Â  Â  const statusEl = document.getElementById('status');
Â  Â  statusEl.style.display = 'block';
Â  Â  try {
Â  Â  Â  Â  const bbox = turf.bbox(polygonFilter);Â 
Â  Â  Â  Â  const zoom = 18;
Â  Â  Â  Â  const lon2tile = (lon, z) => Math.floor((lon + 180) / 360 * Math.pow(2, z));
Â  Â  Â  Â  const lat2tile = (lat, z) => Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1 / Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * Math.pow(2, z));
Â  Â  Â  Â Â 
Â  Â  Â  Â  const startX = lon2tile(bbox[0], zoom);
Â  Â  Â  Â  const endX = lon2tile(bbox[2], zoom);
Â  Â  Â  Â  const startY = lat2tile(bbox[3], zoom);
Â  Â  Â  Â  const endY = lat2tile(bbox[1], zoom);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const maxTilesPerSide = 16;Â 
Â  Â  Â  Â  const chunksX = Math.ceil((endX - startX + 1) / maxTilesPerSide);
Â  Â  Â  Â  const chunksY = Math.ceil((endY - startY + 1) / maxTilesPerSide);

Â  Â  Â  Â  for (let cy = 0; cy < chunksY; cy++) {
Â  Â  Â  Â  Â  Â  for (let cx = 0; cx < chunksX; cx++) {
Â  Â  Â  Â  Â  Â  Â  Â  const cSX = startX + (cx * maxTilesPerSide);
Â  Â  Â  Â  Â  Â  Â  Â  const cEX = Math.min(startX + ((cx + 1) * maxTilesPerSide) - 1, endX);
Â  Â  Â  Â  Â  Â  Â  Â  const cSY = startY + (cy * maxTilesPerSide);
Â  Â  Â  Â  Â  Â  Â  Â  const cEY = Math.min(startY + ((cy + 1) * maxTilesPerSide) - 1, endY);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.innerText = `æ­£åœ¨è™•ç†ç¬¬ (${cx+1}/${chunksX}, ${cy+1}/${chunksY}) å¼µé«˜æ¸…åœ–...`;
Â  Â  Â  Â  Â  Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  Â  Â  Â  Â  Â  canvas.width = (cEX - cSX + 1) * 256; canvas.height = (cEY - cSY + 1) * 256;
Â  Â  Â  Â  Â  Â  Â  Â  const ctx = canvas.getContext('2d');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const tilePromises = [];
Â  Â  Â  Â  Â  Â  Â  Â  for (let x = cSX; x <= cEX; x++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let y = cSY; y <= cEY; y++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const url = `https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/${zoom}/${y}/${x}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tilePromises.push(new Promise((resolve) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const img = new Image();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.crossOrigin = "Anonymous";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.onload = () => { ctx.drawImage(img, (x - cSX) * 256, (y - cSY) * 256); resolve(); };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.onerror = resolve;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  img.src = url;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  await Promise.all(tilePromises);
Â  Â  Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  link.download = `æƒ‡é™½è¡›æ˜Ÿåœ–_${cx+1}_${cy+1}.png`;
Â  Â  Â  Â  Â  Â  Â  Â  link.href = canvas.toDataURL("image/png");
Â  Â  Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(r => setTimeout(r, 800)); // é˜²æ­¢ç€è¦½å™¨é˜»æ“‹
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  statusEl.innerText = "æ‰¹é‡åŒ¯å‡ºå®Œæˆï¼";
Â  Â  Â  Â  setTimeout(() => statusEl.style.display = 'none', 2000);
Â  Â  } catch (err) { alert("åŒ¯å‡ºå¤±æ•—ã€‚"); statusEl.style.display = 'none'; }
}
</script>
</body>
</html>
